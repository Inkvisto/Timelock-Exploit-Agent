# **Timelock-Exploit Agent**

---

## Description

This agent detects when someone with the executor role could escalate privileges and become an admin of the
TimelockController. The agent is separated into four threads:

1. First thread detects the `RoleGranted(bytes32,address,address)` event for the executor and creates an alert when the
   executor gets the proposer or admin roles.
2. Second thread detects when the **TimelockController** vulnerability is exploited as it is described in the
   [post-mortem](https://forum.openzeppelin.com/t/timelockcontroller-vulnerability-post-mortem/14958).
3. Third thread detects untrusted executors as it is described in the
   [post-mortem](https://forum.openzeppelin.com/t/timelockcontroller-vulnerability-post-mortem/14958).
4. Fourth thread detects the `RoleRevoked(bytes32,address,address)` event and provides alerts in 3 different situations:
    1. The contract lost its `Admin` role.
    2. The function `renounceRole()` was used to revoke its own role.
    3. There is common `RoleRevoked(bytes32,address,address)` event.

## Agent Flow

![TimelockAgent.png](https://github.com/Inkvisto/Timelock-Exploit-Agent/blob/main/timelock-exploit.png?raw=true)

## Supported Chains

- Ethereum
- Hardhat local network (31337)


## Alerts

- `TIMELOCK-ZERO-DELAY`
    - Fired when `MinDelayChange(uint256,uint256)` event has `newDuration` argument equal to zero - this means that
      someone set TimelockController Minimum Delay to zero
    - Severity is always set to `Info`
    - FindingType is always set to `Suspicious`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `old_delay` - previous delay
- `TIMELOCK-EXPLOIT`
    - Fired when malicious executor set Minimum Delay to zero, executes the proposal and after that schedules the
      proposal with the same id
    - Severity is always set to `Critical`
    - FindingType is always set to `Exploit`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `executor` - executor address
        - `proposal_id` - proposal id
- `TIMELOCK-PROPOSAL-LIFECYCLE-VIOLATION`
    - Fired when proposal was scheduled after the execution, but Minimum Delay was not changed
    - Severity is always set to `Critical`
    - FindingType is always set to `Suspicious`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `executor` - executor address
        - `proposal_id` - proposal id
- `TIMELOCK-EXECUTOR-PROPOSER`
    - Fired when executor gets the proposal role
    - Severity is always set to `Medium`
    - FindingType is always set to `Suspicious`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `executor` - executor address
        - `initiator` - initiator address
- `TIMELOCK-EXECUTOR-ADMIN`
    - Fired when executor gets the admin role
    - Severity is always set to `Critical`
    - FindingType is always set to `Suspicious`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `executor` - executor address
        - `initiator` - initiator address
- `TIMELOCK-UNTRUSTED-EXECUTOR`
    - Fired when executor has not Proposer role
    - Severity is always set to `High`
    - FindingType is always set to `Suspicious`
    - Metadata:
        - `contract` - TimelockController address
        - `executor` - executor address
- `TIMELOCK-ADMIN-REVOKED`
    - Fired when contract loses its `Admin` role
    - Severity is always set to `High`
    - FindingType is always set to `Suspicious`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `from` - transaction sender address
- `TIMELOCK-ROLE-RENOUNCED`
    - Fired when address renounced its own role
    - Severity is always set to `Medium`
    - FindingType is always set to `Info`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `from` - transaction sender address
        - `role` - hex-role
- `TIMELOCK-ROLE-REVOKED`
    - Fired when there is normal `RoleRevoke` event in the log
    - Severity is always set to `Medium`
    - FindingType is always set to `Info`
    - Metadata:
        - `contract` - TimelockController address
        - `tx_hash` - hash of the transaction
        - `from` - transaction sender address
        - `role` - hex-role
        - `account` - target account


## Requirements
``` tests
@nomicfoundation/hardhat-network-helpers
```

## Run the agent

```shell
npm start
```

```hardhat
  npm hardhat forta:run
```

## Tests

You can test the agent using

```shell
npm test
```
```hardhat
  npm hardhat forta:test
```


